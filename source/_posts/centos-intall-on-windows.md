---
title: 在Window下安装CentOS并安装Nginx、OpenResty
date: 2017年11月26日21:19:59
thumbnail: http://openresty.org/images/logo.png
tags: 
 - Centos
 - OpenResty
 - VMware
 - Nginx
categories: 
 - OpenResty
 - Nginx
---

**本文记录了在window上利用VMware虚拟机安装CentOS并且在CentOS里面安装Nginx、OpenResty的过程** 

主要分为以下四步：

1，在Windows上安装VMware Workstation
2，图解在VMware上安装CentOS
3，在CentOS上安装OpenResty
4，解决Windows下无法访问虚拟机的问题（通过配置iptables）
5，最后介绍使用make方式安装nginx

<!--more-->

----------
# **安装CentOS**

先安装`VMware Workstation`软件，搜索后在Windows自行下载安装。比较简单，这里不再记录。
安装完成后，在`VMware Workstation`中安装CentOS，步骤参考下图

![安装CentOS-1](/imgs/centos-install-on-window-1.png)
![安装CentOS-2](/imgs/centos-install-on-window-2.png)
![安装CentOS-3](/imgs/centos-install-on-window-3.png)
![安装CentOS-4](/imgs/centos-install-on-window-4.png)
![安装CentOS-5](/imgs/centos-install-on-window-5.png)
![安装CentOS-6](/imgs/centos-install-on-window-6.png)
网络选择桥接模式，具体可以参考：[Vmware虚拟机三种网络模式详解](http://blog.csdn.net/noob_f/article/details/51099040)
![安装CentOS-7-配置网络](/imgs/centos-install-on-window-7.png)
![安装CentOS-8-配置内存](/imgs/centos-install-on-window-8.png)

最后点击确定，等待一会后，就可以进入CentOS了。首次进入需要配置网络、语言、用户，配置完成后，使用`ifconfig`命令可以查看Linux的IP，用于在外部使用`XShell`软件访问。


# **安装OpenResty**

本文只介绍CentOS下安装步骤，其他系统请参考 [官网中文安装说明](http://openresty.org/cn/linux-packages.html)：

 1. 添加openresty仓库：
```shell
sudo yum install yum-utils
sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
```
 2. 安装openresty软件包：
```shell
sudo yum install openresty
```
 3. 启动OpenResty：
```shell
cd /usr/local/openresty/nginx/sbin/
./nginx 
```

# **配置iptablse：在windows下访问虚拟机中的OpenResty**
安装`iptables-services`
```shell
yum install iptables-services  
```
设置开机启动：
```shell
systemctl enable iptables  

# 其他命令 参考
systemctl stop iptables  
systemctl start iptables  
systemctl restart iptables  
systemctl reload iptables  
```
保存设置：
```shell
service iptables save  
```
修改iptablse配置，按照格式，添加80端口（下面第10行为添加内容）
```shell
vi /etc/sysconfig/iptables
```
```shell
# Generated by iptables-save v1.4.21 on Sat Nov 25 21:44:44 2017
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [6:592]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Sat Nov 25 21:44:44 2017
```
最后重启iptables使配置生效：
```shell
service iptables restart
```
然后就能在windows下访问页面了
# **遇到的问题**
1，执行`sudo yum install yum-utils`报错：
```shell
Another app is currently holding the yum lock; waiting for it to exit...
  The other application is: PackageKit
    Memory : 132 M RSS (1.0 GB VSZ)
    Started: Sat Nov 25 21:37:18 2017 - 01:40 ago
State  : Running, pid: 11166
```
解决办法：
```shell
ps -ef|grep yum
kill -9 {上一步得到的进程号}
```
2，Nginx 80端口被占用
```shell
netstat -lnp|grep 80  
ps {上一步得到的进程号} # 根据进程号查看进程详情
kill -9 {上一步得到的进程号}
```

# **使用make方式安装nginx**

1，	下载Nginx安装包，注意不要放在下载到/usr/local/nginx下，因为nginx会安装在该目录：
```shell
cd /usr/local/ && mkdir install && cd install
# 下载nginx包
wget http://nginx.org/download/nginx-1.12.2.tar.gz
# 解压
tar zxvf nginx-1.12.2.tar.gz
cd nginx-1.12.2
# 配置
./configure
```

2，安装如果提示缺少PCRE，需要安装PCRE
```shell
checking for PCRE library ... not found
checking for PCRE library in /usr/local/ ... not found
checking for PCRE library in /usr/include/pcre/ ... not found
checking for PCRE library in /usr/pkg/ ... not found
checking for PCRE library in /opt/local/ ... not found

./configure: error: the HTTP rewrite module requires the PCRE library.
You can either disable the module by using --without-http_rewrite_module
option, or install the PCRE library into the system, or build the PCRE library
statically from the source with nginx by using --with-pcre=<path> option

# 如果有以上提示，说明机器未安装pcre，nginx http_rewrite_module 需要pcre正则功能
yum -y install pcre pcre-devel
./configure
```
3，安装如果提示缺少zlib，需要安装zlib
```shell
checking for zlib library ... not found

./configure: error: the HTTP gzip module requires the zlib library.
You can either disable the module by using --without-http_gzip_module
option, or install the zlib library into the system, or build the zlib library
statically from the source with nginx by using --with-zlib=<path> option.

# 如果有以上提示，说明机器未安装zlib，nginx http_gzip_module 需要zlib压缩功能
yum -y install zlib zlib-devel
./configure
```
4，配置成功后make && make install
```shell
# 配置成功后有如下提示，列出了nginx的主要文件所在路径
Configuration summary
  + using system PCRE library
  + OpenSSL library is not used
  + using system zlib library

  nginx path prefix: "/usr/local/nginx"
  nginx binary file: "/usr/local/nginx/sbin/nginx"
  nginx modules path: "/usr/local/nginx/modules"
  nginx configuration prefix: "/usr/local/nginx/conf"
  nginx configuration file: "/usr/local/nginx/conf/nginx.conf"
  nginx pid file: "/usr/local/nginx/logs/nginx.pid"
  nginx error log file: "/usr/local/nginx/logs/error.log"
  nginx http access log file: "/usr/local/nginx/logs/access.log"
  nginx http client request body temporary files: "client_body_temp"
  nginx http proxy temporary files: "proxy_temp"
  nginx http fastcgi temporary files: "fastcgi_temp"
  nginx http uwsgi temporary files: "uwsgi_temp"
  nginx http scgi temporary files: "scgi_temp"


make
make install
```
5，最后启动nginx
```shell
cd /usr/local/nginx/sbin 
./nginx 
```


备注：注意使用` ./configure --help`可以查看nginx的可配置路径和模块，列出如下：

```shell

  --help                             print this message

  --prefix=PATH                      set installation prefix
  --sbin-path=PATH                   set nginx binary pathname
  --modules-path=PATH                set modules path
  --conf-path=PATH                   set nginx.conf pathname
  --error-log-path=PATH              set error log pathname
  --pid-path=PATH                    set nginx.pid pathname
  --lock-path=PATH                   set nginx.lock pathname

  --user=USER                        set non-privileged user for
                                     worker processes
  --group=GROUP                      set non-privileged group for
                                     worker processes

  --build=NAME                       set build name
  --builddir=DIR                     set build directory

  --with-select_module               enable select module
  --without-select_module            disable select module
  --with-poll_module                 enable poll module
  --without-poll_module              disable poll module

  --with-threads                     enable thread pool support

  --with-file-aio                    enable file AIO support

  --with-http_ssl_module             enable ngx_http_ssl_module
  --with-http_v2_module              enable ngx_http_v2_module
  --with-http_realip_module          enable ngx_http_realip_module
  --with-http_addition_module        enable ngx_http_addition_module
  --with-http_xslt_module            enable ngx_http_xslt_module
  --with-http_xslt_module=dynamic    enable dynamic ngx_http_xslt_module
  --with-http_image_filter_module    enable ngx_http_image_filter_module
  --with-http_image_filter_module=dynamic
                                     enable dynamic ngx_http_image_filter_module
  --with-http_geoip_module           enable ngx_http_geoip_module
  --with-http_geoip_module=dynamic   enable dynamic ngx_http_geoip_module
  --with-http_sub_module             enable ngx_http_sub_module
  --with-http_dav_module             enable ngx_http_dav_module
  --with-http_flv_module             enable ngx_http_flv_module
  --with-http_mp4_module             enable ngx_http_mp4_module
  --with-http_gunzip_module          enable ngx_http_gunzip_module
  --with-http_gzip_static_module     enable ngx_http_gzip_static_module
  --with-http_auth_request_module    enable ngx_http_auth_request_module
  --with-http_random_index_module    enable ngx_http_random_index_module
  --with-http_secure_link_module     enable ngx_http_secure_link_module
  --with-http_degradation_module     enable ngx_http_degradation_module
  --with-http_slice_module           enable ngx_http_slice_module
  --with-http_stub_status_module     enable ngx_http_stub_status_module

  --without-http_charset_module      disable ngx_http_charset_module
  --without-http_gzip_module         disable ngx_http_gzip_module
  --without-http_ssi_module          disable ngx_http_ssi_module
  --without-http_userid_module       disable ngx_http_userid_module
  --without-http_access_module       disable ngx_http_access_module
  --without-http_auth_basic_module   disable ngx_http_auth_basic_module
  --without-http_autoindex_module    disable ngx_http_autoindex_module
  --without-http_geo_module          disable ngx_http_geo_module
  --without-http_map_module          disable ngx_http_map_module
  --without-http_split_clients_module disable ngx_http_split_clients_module
  --without-http_referer_module      disable ngx_http_referer_module
  --without-http_rewrite_module      disable ngx_http_rewrite_module
  --without-http_proxy_module        disable ngx_http_proxy_module
  --without-http_fastcgi_module      disable ngx_http_fastcgi_module
  --without-http_uwsgi_module        disable ngx_http_uwsgi_module
  --without-http_scgi_module         disable ngx_http_scgi_module
  --without-http_memcached_module    disable ngx_http_memcached_module
  --without-http_limit_conn_module   disable ngx_http_limit_conn_module
  --without-http_limit_req_module    disable ngx_http_limit_req_module
  --without-http_empty_gif_module    disable ngx_http_empty_gif_module
  --without-http_browser_module      disable ngx_http_browser_module
  --without-http_upstream_hash_module
                                     disable ngx_http_upstream_hash_module
  --without-http_upstream_ip_hash_module
                                     disable ngx_http_upstream_ip_hash_module
  --without-http_upstream_least_conn_module
                                     disable ngx_http_upstream_least_conn_module
  --without-http_upstream_keepalive_module
                                     disable ngx_http_upstream_keepalive_module
  --without-http_upstream_zone_module
                                     disable ngx_http_upstream_zone_module

  --with-http_perl_module            enable ngx_http_perl_module
  --with-http_perl_module=dynamic    enable dynamic ngx_http_perl_module
  --with-perl_modules_path=PATH      set Perl modules path
  --with-perl=PATH                   set perl binary pathname

  --http-log-path=PATH               set http access log pathname
  --http-client-body-temp-path=PATH  set path to store
                                     http client request body temporary files
  --http-proxy-temp-path=PATH        set path to store
                                     http proxy temporary files
  --http-fastcgi-temp-path=PATH      set path to store
                                     http fastcgi temporary files
  --http-uwsgi-temp-path=PATH        set path to store
                                     http uwsgi temporary files
  --http-scgi-temp-path=PATH         set path to store
                                     http scgi temporary files

  --without-http                     disable HTTP server
  --without-http-cache               disable HTTP cache

  --with-mail                        enable POP3/IMAP4/SMTP proxy module
  --with-mail=dynamic                enable dynamic POP3/IMAP4/SMTP proxy module
  --with-mail_ssl_module             enable ngx_mail_ssl_module
  --without-mail_pop3_module         disable ngx_mail_pop3_module
  --without-mail_imap_module         disable ngx_mail_imap_module
  --without-mail_smtp_module         disable ngx_mail_smtp_module

  --with-stream                      enable TCP/UDP proxy module
  --with-stream=dynamic              enable dynamic TCP/UDP proxy module
  --with-stream_ssl_module           enable ngx_stream_ssl_module
  --with-stream_realip_module        enable ngx_stream_realip_module
  --with-stream_geoip_module         enable ngx_stream_geoip_module
  --with-stream_geoip_module=dynamic enable dynamic ngx_stream_geoip_module
  --with-stream_ssl_preread_module   enable ngx_stream_ssl_preread_module
  --without-stream_limit_conn_module disable ngx_stream_limit_conn_module
  --without-stream_access_module     disable ngx_stream_access_module
  --without-stream_geo_module        disable ngx_stream_geo_module
  --without-stream_map_module        disable ngx_stream_map_module
  --without-stream_split_clients_module
                                     disable ngx_stream_split_clients_module
  --without-stream_return_module     disable ngx_stream_return_module
  --without-stream_upstream_hash_module
                                     disable ngx_stream_upstream_hash_module
  --without-stream_upstream_least_conn_module
                                     disable ngx_stream_upstream_least_conn_module
  --without-stream_upstream_zone_module
                                     disable ngx_stream_upstream_zone_module

  --with-google_perftools_module     enable ngx_google_perftools_module
  --with-cpp_test_module             enable ngx_cpp_test_module

  --add-module=PATH                  enable external module
  --add-dynamic-module=PATH          enable dynamic external module

  --with-compat                      dynamic modules compatibility

  --with-cc=PATH                     set C compiler pathname
  --with-cpp=PATH                    set C preprocessor pathname
  --with-cc-opt=OPTIONS              set additional C compiler options
  --with-ld-opt=OPTIONS              set additional linker options
  --with-cpu-opt=CPU                 build for the specified CPU, valid values:
                                     pentium, pentiumpro, pentium3, pentium4,
                                     athlon, opteron, sparc32, sparc64, ppc64

  --without-pcre                     disable PCRE library usage
  --with-pcre                        force PCRE library usage
  --with-pcre=DIR                    set path to PCRE library sources
  --with-pcre-opt=OPTIONS            set additional build options for PCRE
  --with-pcre-jit                    build PCRE with JIT compilation support

  --with-zlib=DIR                    set path to zlib library sources
  --with-zlib-opt=OPTIONS            set additional build options for zlib
  --with-zlib-asm=CPU                use zlib assembler sources optimized
                                     for the specified CPU, valid values:
                                     pentium, pentiumpro

  --with-libatomic                   force libatomic_ops library usage
  --with-libatomic=DIR               set path to libatomic_ops library sources

  --with-openssl=DIR                 set path to OpenSSL library sources
  --with-openssl-opt=OPTIONS         set additional build options for OpenSSL

  --with-debug                       enable debug logging
```